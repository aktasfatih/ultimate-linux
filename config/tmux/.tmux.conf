# Ultimate Linux Development Setup - Tmux Configuration

# Prefix key (Ctrl-Space)
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# General settings
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc"
set -g history-limit 50000
set -g display-time 4000
set -g status-interval 5
set -g focus-events on
set -g mouse on
set -g set-clipboard on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -s escape-time 0
setw -g aggressive-resize on
setw -g automatic-rename on
set -g set-titles on
set -g set-titles-string '#H:#S.#I.#P #W #T'

# Modern tmux features (3.2+)
set -g popup-border-lines rounded
set -g popup-border-style fg=colour8
set -g copy-mode-current-match-style bg=yellow,fg=black
set -g copy-mode-match-style bg=colour239
set -g mode-style bg=colour235,fg=colour223

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off
set -g activity-action none

# Pane borders
set -g pane-border-style fg=colour237
set -g pane-active-border-style fg=colour250
set -g pane-border-format " #P: #{pane_current_command} "
set -g pane-border-status bottom

# Display times
set -g display-panes-time 3000

# Key bindings
# Reload configuration
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Split panes using | and -
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Navigate panes with vim-like keys
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes with vim-like keys
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Navigate windows
bind -r C-h previous-window
bind -r C-l next-window
bind Tab last-window
bind p previous-window
bind n next-window

# Reorder windows
bind -r < swap-window -t -1\; select-window -t -1
bind -r > swap-window -t +1\; select-window -t +1

# Kill pane/window/session
bind x kill-pane
bind X kill-window
bind Q confirm-before -p "kill-session #S? (y/n)" kill-session

# Copy mode
setw -g mode-keys vi
bind Enter copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X cancel
bind -T copy-mode-vi H send-keys -X start-of-line
bind -T copy-mode-vi L send-keys -X end-of-line

# System clipboard integration
# Load dynamic clipboard configuration based on available tools
source-file ~/.tmux.clipboard.conf

# Fallback paste buffer
bind P choose-buffer

# Create new window with current path
bind c new-window -c "#{pane_current_path}"

# Synchronize panes
bind S setw synchronize-panes \; display-message "Synchronize panes: #{?pane_synchronized,on,off}"

# Toggle status bar (moved to b for "bar")
bind b if -F '#{s/off//:status}' 'set status off' 'set status on'

# Session list (restore default binding)
bind s choose-tree -Zs

# Layout shortcuts
bind M-1 select-layout main-horizontal
bind M-2 select-layout main-vertical
bind M-3 select-layout even-horizontal
bind M-4 select-layout even-vertical
bind M-5 select-layout tiled

# Join/send panes
bind J choose-window 'join-pane -h -s "%%"'
bind B break-pane -d

# Session management
bind C-c new-session
bind C-f command-prompt -p find-session 'switch-client -t %%'

# Theme and appearance
# Status bar
set -g status-position top
set -g status-justify left
set -g status-style 'bg=#1e1e2e fg=#cdd6f4'
set -g status-left-length 100
set -g status-right-length 100

# Left side of status bar
set -g status-left '#[fg=#1e1e2e,bg=#89b4fa,bold] #S #[fg=#89b4fa,bg=#313244,nobold]#[fg=#cdd6f4,bg=#313244] #(whoami) #[fg=#313244,bg=#1e1e2e,nobold]'

# Right side of status bar
set -g status-right '#[fg=#313244,bg=#1e1e2e,nobold]#[fg=#cdd6f4,bg=#313244] %Y-%m-%d #[fg=#45475a,bg=#313244,nobold]#[fg=#cdd6f4,bg=#45475a] %H:%M #[fg=#89b4fa,bg=#45475a,nobold]#[fg=#1e1e2e,bg=#89b4fa,bold] #H '

# Window status
setw -g window-status-format '#[fg=#1e1e2e,bg=#313244,nobold]#[fg=#cdd6f4,bg=#313244] #I #W #[fg=#313244,bg=#1e1e2e,nobold]'
setw -g window-status-current-format '#[fg=#1e1e2e,bg=#f38ba8,nobold]#[fg=#1e1e2e,bg=#f38ba8,bold] #I #W #[fg=#f38ba8,bg=#1e1e2e,nobold]'
setw -g window-status-separator ''

# Pane borders
set -g pane-border-style 'fg=#313244'
set -g pane-active-border-style 'fg=#89b4fa'

# Message style
set -g message-style 'fg=#cdd6f4,bg=#313244,bold'

# Clock
setw -g clock-mode-colour '#89b4fa'
setw -g clock-mode-style 24

# Modern tmux keybindings and features (tmux 3.2+)

# Popup windows
bind g display-popup -E -w 80% -h 80% "lazygit || echo 'lazygit not installed'"
bind G display-popup -E -w 80% -h 80% "gh dash || echo 'gh not installed'"
bind C-f display-popup -E -w 80% -h 60% "bash -c 'cd #{pane_current_path} && fzf --preview \"bat --color=always {} 2>/dev/null || cat {}\" | xargs -r nvim'"
bind C-p display-popup -E -w 90% -h 70% -d "#{pane_current_path}" "$HOME/.config/tmux/scripts/tmux-sessionizer"
bind C-w display-popup -E -w 90% -h 70% "$HOME/.config/tmux/scripts/tmux-window-switcher"

# Quick scratch terminal
bind ` if-shell -F '#{==:#{session_name},scratch}' {
    detach-client
} {
    display-popup -E -w 80% -h 80% "tmux new-session -A -s scratch"
}

# URL view and open
bind u capture-pane \; save-buffer /tmp/tmux-buffer \; display-popup -w 80% -h 60% -E "\
    bash -c 'cat /tmp/tmux-buffer | \
    grep -oE \"(https?|ftp|file)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]\" | \
    fzf --preview \"echo {}\" | xargs -r xdg-open'"

# Quick notes
bind N display-popup -E -w 80% -h 80% "nvim ~/notes/$(date +%Y-%m-%d).md"

# Directory navigation with preview
bind e display-popup -E -w 80% -h 60% -d "#{pane_current_path}" "\
    bash -c 'find . -type d -name .git -prune -o -type d -print | \
    fzf --preview \"ls -la {}\" | xargs -r tmux new-window -c'"

# Process viewer
bind P display-popup -E -w 95% -h 95% "btm || htop || top"

# Cheatsheet
bind ? display-popup -E -w 80% -h 80% "bash -c 'cat ~/.config/tmux/tmux-cheatsheet.md | less'"

# Enhanced copy mode
bind v copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X cancel
bind -T copy-mode-vi H send-keys -X start-of-line
bind -T copy-mode-vi L send-keys -X end-of-line

# Search with incremental search
bind / copy-mode \; send-keys ?
bind C-s copy-mode \; send-keys ?

# Smart pane creation - maintain current path
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Quick layouts
bind C-1 select-layout even-horizontal \; display-message "Layout: even-horizontal"
bind C-2 select-layout even-vertical \; display-message "Layout: even-vertical"
bind C-3 select-layout main-horizontal \; display-message "Layout: main-horizontal"
bind C-4 select-layout main-vertical \; display-message "Layout: main-vertical"
bind C-5 select-layout tiled \; display-message "Layout: tiled"

# Session templates
bind T display-popup -E -w 60% -h 60% "bash -c '\
    echo \"Select project template:\" && \
    echo \"1) Web Development\" && \
    echo \"2) Python Project\" && \
    echo \"3) Go Project\" && \
    echo \"4) DevOps\" && \
    read -n 1 choice && \
    $HOME/.config/tmux/scripts/tmux-project-template $choice'"

# Plugins (using TPM - Tmux Plugin Manager)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-net-speed'
set -g @plugin 'christoomey/vim-tmux-navigator'

# Enhanced plugins for modern workflow
set -g @plugin 'laktak/extrakto'                # Extract text from pane
set -g @plugin 'tmux-plugins/tmux-fpp'          # Facebook PathPicker integration
set -g @plugin 'schasse/tmux-jump'              # Jump to text with hints
set -g @plugin 'tmux-plugins/tmux-sessionist'   # Session management utilities

# Theme plugins (uncomment one to use)
# set -g @plugin 'catppuccin/tmux'               # Catppuccin theme
# set -g @plugin 'dracula/tmux'                  # Dracula theme
# set -g @plugin 'arcticicestudio/nord-tmux'     # Nord theme

# Plugin settings
# Yank plugin configuration
set -g @yank_selection 'clipboard'
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-and-cancel'
set -g @yank_with_mouse on

# Resurrect
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-save 'S'
set -g @resurrect-restore 'R'

# Continuum
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Prefix highlight
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_show_sync_mode 'on'
set -g @prefix_highlight_prefix_prompt 'PREFIX'
set -g @prefix_highlight_copy_prompt 'COPY'
set -g @prefix_highlight_sync_prompt 'SYNC'

# Battery
set -g @batt_icon_status_charged ''
set -g @batt_icon_status_charging ''
set -g @batt_icon_status_discharging ''
set -g @batt_icon_status_attached ''
set -g @batt_icon_status_unknown ''

# CPU
set -g @cpu_low_icon "▁"
set -g @cpu_medium_icon "▃"
set -g @cpu_high_icon "▆"

# Net speed
set -g @net_speed_interfaces "eth0 wlan0"
set -g @download_speed_format "%10s"
set -g @upload_speed_format "%10s"
set -g @net_speed_format "D:%10s U:%10s"

# Extrakto
set -g @extrakto_split_size "15"
set -g @extrakto_clip_tool "xclip -selection clipboard"
set -g @extrakto_fzf_tool "fzf"
set -g @extrakto_open_tool "xdg-open"

# Jump
set -g @jump-key 'j'
set -g @jump-bg-color '\e[0m\e[90m'
set -g @jump-fg-color '\e[1m\e[31m'

# Sessionist
set -g @sessionist-goto 'g'

# Update status bar with plugin information
set -g status-right '#[fg=#313244,bg=#1e1e2e,nobold]#[fg=#cdd6f4,bg=#313244] #{cpu_icon} #{cpu_percentage} #[fg=#45475a,bg=#313244,nobold]#[fg=#cdd6f4,bg=#45475a] #{battery_icon} #{battery_percentage} #[fg=#585b70,bg=#45475a,nobold]#[fg=#cdd6f4,bg=#585b70] %Y-%m-%d %H:%M #[fg=#89b4fa,bg=#585b70,nobold]#[fg=#1e1e2e,bg=#89b4fa,bold] #H #{prefix_highlight}'

# Local overrides
if-shell "[ -f ~/.tmux.conf.local ]" 'source ~/.tmux.conf.local'

# Initialize TPM (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'